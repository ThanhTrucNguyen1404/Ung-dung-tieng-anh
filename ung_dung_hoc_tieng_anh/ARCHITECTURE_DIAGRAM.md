# 🏗️ ANALYTICS SYSTEM - ARCHITECTURE DIAGRAM

## 📊 TỔNG QUAN KIẾN TRÚC

```
┌─────────────────────────────────────────────────────────────────────┐
│                         USER INTERFACE                               │
│                                                                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
│  │ Lesson     │  │ Exercise   │  │ Dashboard  │  │ Profile    │   │
│  │ Page       │  │ Page       │  │ Page       │  │ Page       │   │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘   │
│        │               │                │                │           │
└────────┼───────────────┼────────────────┼────────────────┼──────────┘
         │               │                │                │
         └───────────────┴────────────────┴────────────────┘
                                  │
         ┌────────────────────────┴────────────────────────┐
         │                                                  │
┌────────▼────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                                │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  Dashboard Widgets                                          │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐     │    │
│  │  │ StatCard │ │ Progress │ │ Heatmap  │ │ WeakSkill│     │    │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘     │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                       │
└───────────────────────────────┬───────────────────────────────────┘
                                │
         ┌──────────────────────┴──────────────────────┐
         │                                              │
┌────────▼──────────────────────────────────────────────────────────┐
│                     DOMAIN LAYER                                   │
│                   (Business Logic)                                 │
│                                                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Services                                                   │  │
│  │  ┌──────────────────┐  ┌──────────────────┐               │  │
│  │  │AnalyticsService  │  │ SessionTracking  │               │  │
│  │  │                  │  │     Service      │               │  │
│  │  │ • Dashboard      │  │                  │               │  │
│  │  │ • Weekly Report  │  │ • Start Session  │               │  │
│  │  │ • AI Analysis    │  │ • Save Result    │               │  │
│  │  │ • Heatmap        │  │ • End Session    │               │  │
│  │  └──────────────────┘  └──────────────────┘               │  │
│  │                                                             │  │
│  │  ┌──────────────────┐                                      │  │
│  │  │ PrivacyService   │                                      │  │
│  │  │                  │                                      │  │
│  │  │ • Export Data    │                                      │  │
│  │  │ • History        │                                      │  │
│  │  │ • Delete Data    │                                      │  │
│  │  └──────────────────┘                                      │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Entities                                                   │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐           │  │
│  │  │UserProfile │  │  Session   │  │  Exercise  │           │  │
│  │  │   Entity   │  │   Entity   │  │   Result   │           │  │
│  │  └────────────┘  └────────────┘  └────────────┘           │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────┬───────────────────────────────────┘
                              │
         ┌────────────────────┴────────────────────┐
         │                                          │
┌────────▼──────────────────────────────────────────────────────────┐
│                       DATA LAYER                                   │
│                  (Data Management)                                 │
│                                                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Repository                                                 │  │
│  │  ┌──────────────────────────────────────────────────┐     │  │
│  │  │   AnalyticsRepositoryImpl                        │     │  │
│  │  │                                                   │     │  │
│  │  │   • getUserProfile()                             │     │  │
│  │  │   • createUser()                                 │     │  │
│  │  │   • startLearningSession()                       │     │  │
│  │  │   • completeLearningSession()                    │     │  │
│  │  │   • saveExerciseResult()                         │     │  │
│  │  │   • getUserSessions()                            │     │  │
│  │  │   • getUserExerciseResults()                     │     │  │
│  │  │   • calculateTotalXp()                           │     │  │
│  │  │   • calculateStreak()                            │     │  │
│  │  │   • calculateSkillProgress()                     │     │  │
│  │  └──────────────────────────────────────────────────┘     │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │  Models (Firestore ↔ Entity)                              │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐           │  │
│  │  │UserProfile │  │  Session   │  │  Exercise  │           │  │
│  │  │   Model    │  │   Model    │  │   Result   │           │  │
│  │  │            │  │            │  │   Model    │           │  │
│  │  │ • from()   │  │ • from()   │  │ • from()   │           │  │
│  │  │ • to()     │  │ • to()     │  │ • to()     │           │  │
│  │  └────────────┘  └────────────┘  └────────────┘           │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────┬───────────────────────────────────┘
                              │
         ┌────────────────────┴────────────────────┐
         │                                          │
┌────────▼──────────────────────────────────────────────────────────┐
│                    FIREBASE FIRESTORE                              │
│                                                                     │
│  ┌────────────┐      ┌────────────────┐      ┌───────────────┐   │
│  │   users    │      │    learning    │      │   exercise    │   │
│  │ collection │      │    sessions    │      │   results     │   │
│  │            │      │   collection   │      │  collection   │   │
│  │ • total_xp │      │ • duration     │      │ • accuracy    │   │
│  │ • streak   │      │ • completed    │      │ • xp_earned   │   │
│  │ • minutes  │      │ • skill        │      │ • skill       │   │
│  └────────────┘      └────────────────┘      └───────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 DATA FLOW DIAGRAM

### Flow 1: User Starts Learning

```
┌──────────┐        ┌──────────────┐        ┌────────────┐
│  Lesson  │   1    │   Session    │   2    │ Analytics  │
│   Page   │───────▶│   Tracking   │───────▶│ Repository │
└──────────┘        │   Service    │        └────────────┘
                    └──────────────┘              │
                                                  │ 3
                                                  ▼
                    ┌──────────────────────────────────┐
                    │        Firebase Firestore        │
                    │  learning_sessions.add({         │
                    │    user_id, skill, start_time    │
                    │  })                              │
                    └──────────────────────────────────┘
```

### Flow 2: User Completes Exercise

```
┌──────────┐        ┌──────────────┐        ┌────────────┐
│ Exercise │   1    │   Session    │   2    │ Analytics  │
│   Page   │───────▶│   Tracking   │───────▶│ Repository │
└──────────┘        │   Service    │        └────────────┘
     │              └──────────────┘              │
     │                                            │ 3
     │              ┌──────────────────────────────────┐
     │              │        Firebase Firestore        │
     │              │  exercise_results.add({          │
     │              │    correct, total, accuracy,     │
     │              │    xp_earned                     │
     │              │  })                              │
     │              └──────────────────────────────────┘
     │                                            │
     │ Calculate                                  │ 4
     │ XP & Accuracy                              ▼
     │              ┌──────────────────────────────────┐
     └─────────────▶│  users.update({                  │
                    │    total_xp: +xp,                │
                    │    last_active: now              │
                    │  })                              │
                    └──────────────────────────────────┘
```

### Flow 3: Dashboard Load

```
┌──────────┐        ┌──────────────┐        ┌────────────┐
│Dashboard │   1    │  Analytics   │   2    │ Analytics  │
│   Page   │───────▶│   Service    │───────▶│ Repository │
└──────────┘        └──────────────┘        └────────────┘
     ▲                                             │
     │                                             │ 3
     │                                             ▼
     │              ┌──────────────────────────────────┐
     │              │        Firebase Firestore        │
     │              │                                  │
     │    Query     │  • users.get(userId)            │
     │      4       │  • sessions.where(user_id)      │
     │◀─────────────│  • results.where(user_id)       │
     │              │                                  │
     │              └──────────────────────────────────┘
     │
     │ 5. Calculate
     │    • Total XP
     │    • Streak
     │    • Progress
     │    • Heatmap
     │    • Weak Skills
     │
     └─────────────▶ Display Dashboard
```

---

## 🎯 COMPONENT INTERACTION DIAGRAM

```
┌─────────────────────────────────────────────────────────────────┐
│                    USER ACTIONS                                  │
└─────────────────────────────────────────────────────────────────┘
              │                 │                 │
         Start Lesson     Complete Exercise   View Dashboard
              │                 │                 │
              ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                  SESSION TRACKING SERVICE                        │
│                                                                   │
│  startSession()        saveExerciseResult()      (N/A)          │
│       │                        │                                 │
│       ▼                        ▼                                 │
│  ┌─────────────┐        ┌─────────────┐                        │
│  │ Track Start │        │ Calculate   │                        │
│  │ Time        │        │ XP & Acc    │                        │
│  └─────────────┘        └─────────────┘                        │
└─────────────────────────────────────────────────────────────────┘
              │                 │                 │
              └─────────────────┴─────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  ANALYTICS REPOSITORY                            │
│                                                                   │
│  startLearningSession()  saveExerciseResult()  getDashboardData()│
│          │                       │                    │          │
│          ▼                       ▼                    ▼          │
│    ┌──────────┐           ┌──────────┐        ┌──────────┐     │
│    │  Insert  │           │  Insert  │        │  Query   │     │
│    │  Session │           │  Result  │        │  & Calc  │     │
│    └──────────┘           └──────────┘        └──────────┘     │
└─────────────────────────────────────────────────────────────────┘
              │                 │                 │
              └─────────────────┴─────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FIRESTORE                                   │
│                                                                   │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐              │
│  │  Insert  │      │  Insert  │      │  Query   │              │
│  │  Session │      │  Result  │      │  Data    │              │
│  │  Doc     │      │  Doc     │      │  Docs    │              │
│  └──────────┘      └──────────┘      └──────────┘              │
│                                                                   │
│  Collections:  learning_sessions | exercise_results | users     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 STATE MANAGEMENT DIAGRAM

```
┌──────────────────────────────────────────────────────────────────┐
│                      DASHBOARD STATE                              │
└──────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                 Initial                 Loading
                  State                   State
              (No data)              (Show spinner)
                    │                       │
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                 Success                  Error
                  State                   State
              (Show data)            (Show error)
                    │                       │
                    │                       │
                    ▼                       ▼
        ┌─────────────────┐     ┌──────────────────┐
        │ DashboardData   │     │ Error Message    │
        │                 │     │                  │
        │ • totalXp       │     │ • Retry Button   │
        │ • streak        │     │                  │
        │ • hours         │     └──────────────────┘
        │ • progress      │
        │ • heatmap       │
        │ • weakSkills    │
        └─────────────────┘
```

---

## 🔐 SECURITY FLOW DIAGRAM

```
┌──────────────────────────────────────────────────────────────────┐
│                      USER REQUEST                                 │
│                                                                    │
│  User wants to: View Dashboard / Save Result / Export Data       │
└──────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌──────────────────────────────────────────────────────────────────┐
│                   AUTHENTICATION CHECK                            │
│                                                                    │
│  Is user logged in? (Firebase Auth)                              │
└──────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                  YES                       NO
                    │                       │
                    ▼                       ▼
┌──────────────────────────────┐  ┌──────────────────────┐
│  AUTHORIZATION CHECK          │  │  REDIRECT TO LOGIN   │
│                               │  └──────────────────────┘
│  Does userId match auth.uid?  │
└──────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
      YES                       NO
        │                       │
        ▼                       ▼
┌──────────────────┐  ┌──────────────────────┐
│  ALLOW ACCESS    │  │  DENY ACCESS         │
│                  │  │  (403 Forbidden)     │
│  Execute request │  └──────────────────────┘
└──────────────────┘
        │
        ▼
┌──────────────────────────────────────────────────────────────────┐
│                      FIRESTORE RULES                              │
│                                                                    │
│  match /users/{userId} {                                          │
│    allow read, write: if request.auth.uid == userId;             │
│  }                                                                │
│                                                                    │
│  match /learning_sessions/{sessionId} {                           │
│    allow read: if request.auth.uid == resource.data.user_id;     │
│    allow create: if request.auth.uid ==                          │
│                      request.resource.data.user_id;              │
│  }                                                                │
│                                                                    │
│  match /exercise_results/{resultId} {                             │
│    allow read: if request.auth.uid == resource.data.user_id;     │
│    allow create: if request.auth.uid ==                          │
│                      request.resource.data.user_id;              │
│  }                                                                │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🧮 CALCULATION FLOW DIAGRAM

### XP Calculation

```
┌──────────────────────────────────────┐
│   User completes exercise            │
│   • correct_answers = 8              │
│   • total_questions = 10             │
│   • completed = true                 │
│   • skill = vocabulary               │
└──────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│   XpRewards.calculateXp()            │
│                                      │
│   xp = 0                             │
│   ┌──────────────────────────────┐  │
│   │ correct_answers * 5          │  │
│   │ 8 * 5 = 40                   │  │
│   └──────────────────────────────┘  │
│   xp += 40                           │
│                                      │
│   ┌──────────────────────────────┐  │
│   │ if completed                 │  │
│   │   xp += 10                   │  │
│   └──────────────────────────────┘  │
│   xp += 10                           │
│                                      │
│   ┌──────────────────────────────┐  │
│   │ if perfect (8 != 10)         │  │
│   │   No bonus                   │  │
│   └──────────────────────────────┘  │
│                                      │
│   Final XP = 50                      │
└──────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│   Update Firestore                   │
│   users.update({                     │
│     total_xp: +50                    │
│   })                                 │
└──────────────────────────────────────┘
```

### Streak Calculation

```
┌──────────────────────────────────────┐
│   Calculate Streak                   │
│   • Get all sessions for user        │
│   • Group by date                    │
└──────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│   For each date:                     │
│   Calculate total minutes            │
│                                      │
│   Today:     15 min ✅ (>= 10)      │
│   Yesterday: 20 min ✅ (>= 10)      │
│   2 days ago: 5 min ❌ (< 10)       │
└──────────────────────────────────────┘
                 │
                 ▼
┌──────────────────────────────────────┐
│   Count consecutive days             │
│   with >= 10 minutes                 │
│                                      │
│   Today:     ✅ → streak = 1         │
│   Yesterday: ✅ → streak = 2         │
│   2 days ago: ❌ → STOP              │
│                                      │
│   Final Streak = 2                   │
└──────────────────────────────────────┘
```

---

## 📈 METRICS DASHBOARD STRUCTURE

```
┌─────────────────────────────────────────────────────────────────┐
│                      DASHBOARD PAGE                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────────── TỔNG QUAN ──────────────────────┐        │
│  │                                                      │        │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │        │
│  │  │    ⭐    │  │    🔥    │  │    ⏱️    │         │        │
│  │  │  1,250   │  │    5     │  │  12.0h   │         │        │
│  │  │   XP     │  │ Streak   │  │ Học tập  │         │        │
│  │  └──────────┘  └──────────┘  └──────────┘         │        │
│  │                                                      │        │
│  │  Source: exercise_results    learning_sessions     │        │
│  └──────────────────────────────────────────────────────┘        │
│                                                                   │
│  ┌─────────────── TIẾN ĐỘ KỸ NĂNG ───────────────┐            │
│  │                                                  │            │
│  │  Từ vựng    ████████░░  75%                     │            │
│  │  Ngữ pháp   ██████░░░░  60%                     │            │
│  │  Nghe       ████░░░░░░  45%                     │            │
│  │  Nói        ███░░░░░░░  30%                     │            │
│  │  Đọc        █████░░░░░  55%                     │            │
│  │  Viết       ████░░░░░░  40%                     │            │
│  │                                                  │            │
│  │  Formula: Avg(accuracy) per skill               │            │
│  └──────────────────────────────────────────────────┘            │
│                                                                   │
│  ┌──────────── LỊCH HỌC TẬP (30 NGÀY) ──────────┐              │
│  │                                                │              │
│  │  [GitHub-style Heatmap]                       │              │
│  │  ▓▓░░▓░░▓▓▓░░▓░░░░▓▓░░░░░░░░▓▓░            │              │
│  │                                                │              │
│  │  Source: learning_sessions grouped by date    │              │
│  └────────────────────────────────────────────────┘              │
│                                                                   │
│  ┌────────── KỸ NĂNG CẦN CẢI THIỆN ──────────┐                │
│  │                                              │                │
│  │  ⚠️ AI phát hiện                             │                │
│  │                                              │                │
│  │  Nói                            30%          │                │
│  │  💡 Luyện tập Nói 30 phút/ngày              │                │
│  │  ──────────────────────────────────         │                │
│  │  Viết                           40%          │                │
│  │  💡 Luyện tập Viết 20 phút/ngày             │                │
│  │                                              │                │
│  │  Logic: accuracy < 60% → weak               │                │
│  └──────────────────────────────────────────────┘                │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

**Version:** 1.0.0  
**Last Updated:** December 26, 2025  
**Status:** ✅ Complete

